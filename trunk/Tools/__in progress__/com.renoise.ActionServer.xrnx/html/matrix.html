~{do L:set_header("Cache-Control", "no-cache, max-age: 0") end}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" dir="ltr">
<head>
<title>Renoise Matrix</title>
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link type="text/css" href="/default.css" media="screen" rel="stylesheet" />

    <!-- required scripts -->
    <script type="text/javascript" src="/js/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="/js/jquery.chromatable.js"></script>
    <script type="text/javascript" src="/js/jquery.scrollTo-min.js"></script>


    <style type="text/css">
      body {
         background-color: black;
         font-size: 10px;
         overflow-y: hidden;
      }
      th{
        color: white;
        background-color: black;
      }
      th.off {
        color: #888;
      }
      th.muted {
        text-decoration: line-through;
        color: #888;
      }
      th:hover, th.hover {
        text-decoration: underline;
      }
      td {
        width: 80px;
        height: 40px;
        border: 1px solid #555;
        color: white;
        text-align: center;
      }
      
      ._thead {
        border-spacing: 0;
      }
      
      ._thead th {
        padding: 2px;
      }
      
      .s, .l{
        font-weight: bold;
        color: #aaa;
        width: 20px;
      }

      .s:hover, .l:hover {
        border: 1px dotted red;
        cursor: pointer;
        color: white;
      }
      
      .current_seq .s {
        color: white;
      }

      .pid {
        background-color: #BE8D18;
        font-weight: bold;
        border: 2px solid white;
        width: 30px;
        color: black;
      }
      .pid:hover {
        background-color: #FFDF59;
      }
      .pid:active {
        background-color: #DEAD38;
      }
      #playing {
        background-color: #FEBD48;
      }
      .pattern {
        border: 2px solid #eee;
        background-color: pink;
      }
      .pattern:hover, .pid:hover {
        border: 2px dotted red;
        cursor: pointer;
      }
      .pattern:active {
        background-color: red;
      }
      .empty {
        background-color: black;
      }
      .seq_mute {
        background-color: purple;
      }
      .send {
        background-color: darkgreen;
      }
      .mst {
        background-color: #333;
      }
      .mst:hover {
        cursor: default;
        border: none;
        border: 2px solid #eee;
      }
      tr.current_seq td {
        border-top: 4px solid red;
        border-bottom: 4px solid red;
      }
      .label {
        width: 160px;
        border: 1px solid #555;
        background-color: #333;
        color: white;
        text-align: center;
        padding: 2px;
      }
    </style>

</head>

<body>
  <div id="center">
    ~{do
        function s()
          return renoise.song()
        end

        local str = ""
        local function out(s)
          str = str .. "\n"  .. s
        end

        local function get_mute_state(state)
          local states = {'active','off','muted'}
          return states[state]
        end

        -------------------

        out("<table id='table_matrix'>")

        -- get tracks
        local tnum = #s().tracks
        out("<thead><tr><th title='Schedule'>S</th><th title='Loop'>L</th><th>#</th><th>label</th>")
        for tid,t in ipairs(s().tracks) do
          local classes = table.create()
          out(("<th id='t%02d' class='%s'>%s</th>")
            :format(tid, get_mute_state(t.mute_state), t.name))
        end
        out("</tr></thead><tbody>")
    
        -- get patterns
        local pattern
        for sid,pid in pairs(s().sequencer.pattern_sequence) do
          local id = ''
          if (sid == s().transport.playback_pos.sequence) then
              id = "id='playing'"
          end
          out("<tr>")
          local name = s().patterns[pid].name
          out(("<td class='s'>&gt;</td><td class='l'></td><td %s class='pid' title='%d'>%d</td><td class='label'>%s</td>"):format(id,sid,pid-1,name))
          local seq_mute = false
          for tid=1,tnum do
            for pos,col in s().pattern_iterator:lines_in_pattern_track(pid, tid) do
              seq_mute = s().sequencer:track_sequence_slot_is_muted(tid, sid)
              break
            end

            -- add classes
            local classes = table.create{"pattern"}
            if (s().patterns[pid].tracks[tid].is_empty) then
              classes:insert("empty")
            end
            if (seq_mute) then
              classes:insert("seq_mute")
            end
            local track_type = s().tracks[tid].type
            if (track_type == renoise.Track.TRACK_TYPE_MASTER) then
              classes:insert("mst")
            elseif (track_type == renoise.Track.TRACK_TYPE_SEND) then
              classes:insert("send")
            end

            out( ("<td class='%s' title='seq[%02d]/track[%02d]'></td>")
              :format(classes:concat(' '),sid, tid ) )

          end
          out("</tr>")
        end

        out("</tbody></table>")
        OUT = str
    end}

  </div>

  <script type="text/javascript">

    $(document).ready(function(){

      //Floating Table Head
      $("#table_matrix").chromatable({
        height: "600px",
        width: "1000px"
      });

      //Track Colors
      
      //Initial Playback Pos
      $('#playing').parent().addClass('current_seq');

      //Scroll To Initial Playback Pos
      //$('table_matrix').focus();
      //$.scrollTo('#playing', 500);
    });

    //Track Hover
    var old_tid = 0;
    $("td").mouseover(function(){
      if (!$(this).hasClass('pattern')) return false;
      var pos = $(this).attr('title');
      var tstr = pos.match(/track\[\d+\]/);
      var tid = tstr[0].slice(6,-1);
      if (old_tid != tid) {
        $("#t"+old_tid).removeClass("hover");
        $("#t"+tid).addClass("hover");
      }
      old_tid = tid;
    });

    //Seq Trigger
    $(".pid").live('click', function(){
     var url = "/Seq. Triggering/Trigger/Sequence XX [Set]?i="+$(this).attr('title');
     var p = this;
     $.post(url, {ajax:true}, function(){
      $('.current_seq').removeClass('current_seq');
      $(p).parent().addClass('current_seq');
      $('#playing').removeAttr('id');
      $(p).attr('id','playing');
     });
     return false;
    });

    //Seq Mute
    $(".pattern").live('click', function(){
     var p = this
          
     var title = $(this).attr('title');
     var arr = title.match(/\d+/g);
     var seq = arr[0];
     var tid = arr[1];
     
     ~{do
       local url = Util:urlencode(
         "/Seq. Muting/Seq. XX [Toggle]/Seq. #seq/Mute Track #tid [Toggle]")
       url = url:gsub("%%23seq", "%%23'+seq+'")  
       url = url:gsub("%%23tid", "%%23'+tid+'")         
       OUT = ("var url = '%s';"):format(url)
     end }
     
     $.post(url, {ajax:true}, function(){
      $(p).toggleClass('seq_mute');
     });
     return false;
    });
  </script>
</body>
</html>
