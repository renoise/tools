~{do
  -- http://www.mozilla.org/projects/netlib/http/http-caching-faq.html
  L:set_header("Cache-control", "no-cache")
  L:set_header("Cache-control", "no-store")
  L:set_header("Pragma", "no-cache")
  L:set_header("Expires", "0")
end}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" dir="ltr">
<head>
<title>Renoise Matrix</title>
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link type="text/css" href="/default.css" media="screen" rel="stylesheet" />

    <!-- required scripts -->
    <script type="text/javascript" src="/js/jquery-1.4.2.js"></script>
    <script type="text/javascript" src="/js/jquery.chromatable.js"></script>
    <script type="text/javascript" src="/js/jquery.scrollTo-min.js"></script>

    <style type="text/css">
      body {
         background-color: black;
         font-size: 10px;
         overflow-y: hidden;
      }
      th{
        color: white;
        background-color: black;
      }
      th.off {
        color: #888;
      }
      th.muted {
        text-decoration: line-through;
        color: #888;
      }
      th:hover, th.hover {
        text-decoration: underline;
      }
      td {
        width: 80px;
        height: 40px;
        border: 1px solid #555;
        color: white;
        text-align: center;
      }
      
      ._thead {
        border-spacing: 0;
      }
      
      ._thead th {
        padding: 2px;
      }
      
      .s, .l{
        font-weight: bold;
        color: #aaa;
        width: 20px;
      }

      .s:hover, .l:hover {
        border: 1px dotted red;
        cursor: pointer;
        color: white;
      }
      
      .current_seq .s {
        color: white;
      }

      .pid {
        background-color: #BE8D18;
        font-weight: bold;
        border: 2px solid white;
        width: 30px;
        color: black;
      }
      .pid:hover {
        background-color: #FFDF59;
      }
      .pid:active {
        background-color: #DEAD38;
      }
      .playing {
        background-color: #FEBD48;
      }
      .pattern {
        border: 2px solid #eee;
        background-color: pink;
      }
      .pattern:hover, .pid:hover {
        border: 2px dotted red;
        cursor: pointer;
      }
      .pattern:active {
        background-color: red;
      }
      .empty {
        background-color: black;
      }
      .send {
        background-color: darkgreen;
      }
      .mst {
        background-color: #333;
      }
      .mst:hover {
        cursor: default;
        border: none;
        border: 2px solid #eee;
      }
      tr.current_seq td {
        border-top: 4px solid red;
        border-bottom: 4px solid red;
      }
      .label {
        width: 160px;
        border: 1px solid #555;
        background-color: #333;
        color: white;
        text-align: center;
        padding: 2px;
      }
      .seq_mute {
        background-color: purple;
      }
    </style>

</head>

<body>
  <div id="center">
      <div id="test-tools" style="border: white; padding: 5px; margin: 10px; color: white"><strong>Test Tools</strong> </div>

      <div id="matrix_placeholder"><!-- Matrix Table goes here --></div>

      <div id="log" style="margin-top: 20px; width: 1000px; background-color: white; color: black; height: 100px; overflow-y: auto"></log>

  </div>

  <script type="text/javascript">
    var autoscroll = false;

    var autoupdate = true;
    var autoupdater = null;
    var au_interval = 200;

    var client_id = ~{do
        local client = L:generate_client()
        OUT = client.id
      end};


    function set_sid(sid){
      $('.current_seq').removeClass('current_seq');
      $('#sid'+sid).parent().addClass('current_seq');
      $('.playing').removeClass('playing');
      $('#sid'+sid).addClass('playing');
      if (autoscroll){
        $.scrollTo('.current_seq', 500);
      }
    }

    //s42t04
    function set_mute_state(data){
      $.each(data, function(k,v){
        $('#'+k).toggleClass('seq_mute', v);
      });
    }

    function load_matrix_table(callback){
      //Get Matrix
      $.get('/matrix/matrix_table.lua', function(data){
        
        //Display Content
        $("#matrix_placeholder").html(data);

        //Floating Table Head
        $("#table_matrix").chromatable({
          height: "600px",
          width: "1000px"
        });

        //Track Colors

        //Initial Playback Pos
        $('.playing').parent().addClass('current_seq');
        
        callback();
      });
    }
    
    function update(data){
      $('#log').prepend("<p>"+data+"</p>");
      //eventid:[k=v]
      data = $.parseJSON(data);
      $.each(data, function(k,event){
        switch(event.key) {
          case "sid": set_sid(event.value); break;
          case "mutes_changed": set_mute_state(event.value); break;
          case "song_change": load_matrix_table(); break;
        }
      });

    }
    
    function loop(){
      if (autoupdate){
        $.get('/matrix/get-song-updates.lua', {client_id: client_id}, function(data){ update(data); } );
      }
      setTimeout('loop()', au_interval);
    }


    $(document).ready(function(){
      if (true || !autoupdate){
        $("#test-tools").append("<button id='update'>update ["+client_id+"]</button>");
        $("#update").click(function(){
          $.get('/matrix/get-song-updates.lua', {client_id: client_id}, function(data){ update(data); } );
        });

        $("#test-tools").append("<button id='autoupdate'>disable auto-update</button>");
        $("#autoupdate").toggle(function(){
          autoupdate = false;
          $("#autoupdate").text("enable auto-update");
          $("#log").prepend("<p>disabled auto-update</p>");
        }, function(){
          autoupdate = true;
          $("#autoupdate").text("disable auto-update");
          $("#log").prepend("<p>enabled auto-update</p>");
        });
      }


      //Polling Renoise for song changes
        load_matrix_table(loop);

    }); // end document ready



    //Track Hover
    var old_tid = 0;
    $("td").mouseover(function(){
      if (!$(this).hasClass('pattern')) return false;
      var pos = $(this).attr('title');
      var tstr = pos.match(/track\[\d+\]/);
      var tid = tstr[0].slice(6,-1);
      if (old_tid != tid) {
        $("#t"+old_tid).removeClass("hover");
        $("#t"+tid).addClass("hover");
      }
      old_tid = tid;
    });

    //Seq Trigger
    $(".pid").live('click', function(){
      var url = "/Seq. Triggering/Trigger/Sequence XX [Set]?i="+$(this).attr('title');
      var p = this;
      $.post(url, {ajax:true}, function(){
        $('.current_seq').removeClass('current_seq');
        $(p).parent().addClass('current_seq');
        $('.playing').removeClass('playing');
        $(p).addClass('playing');
      });
      return false;
    });

    //Seq Mute
    $(".pattern").live('click', function(){
     var p = this
          
     var title = $(this).attr('title');
     var arr = title.match(/\d+/g);
     var seq = arr[0];
     var tid = arr[1];
     
     ~{do
       local url = Util:urlencode(
         "/Seq. Muting/Seq. XX [Toggle]/Seq. #seq/Mute Track #tid [Toggle]")
       url = url:gsub("%%23seq", "%%23'+seq+'")  
       url = url:gsub("%%23tid", "%%23'+tid+'")         
       OUT = ("var url = '%s';"):format(url)
     end }
     
     $.post(url, {ajax:true}, function(){
      $(p).toggleClass('seq_mute');
     });
     return false;
    });
  </script>
</body>
</html>
