~{do
  -- http://www.mozilla.org/projects/netlib/http/http-caching-faq.html
  L:set_header("Cache-control", "no-cache")
  L:set_header("Cache-control", "no-store")
  L:set_header("Pragma", "no-cache")
  L:set_header("Expires", "0")
end}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" dir="ltr">
<head>
<title>Renoise Matrix</title>
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link type="text/css" href="/default.css" media="screen" rel="stylesheet" />

    <!-- required scripts -->
    <script type="text/javascript" src="/js/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="/js/jquery.chromatable.js"></script>
    <script type="text/javascript" src="/js/jquery.scrollTo-min.js"></script>

    <link type="text/css" href="matrix.css" media="screen" rel="stylesheet" />

</head>

<body>
  <div id="center">
      <div id="test-tools"></div>

      <div id="matrix_placeholder"><!-- Matrix Table goes here --></div>

      <div id="log"></log>

  </div>

  <script type="text/javascript">
    var debug = true;

    var autoscroll = false;

    var autoupdate = true;
    var autoupdater = null;
    var au_interval = 200;

    var client_id = ~{do
        local client = L:generate_client()
        OUT = client.id
      end};

    function set_sid(sid){
      $('.scheduled').removeClass('scheduled');
      $('.current_seq').removeClass('current_seq');
      $('#s'+sid).addClass('current_seq');
      if (autoscroll){
        $.scrollTo('.current_seq', 500);
      }
    }

    //s42t04
    function set_mute_state(data){
      $.each(data, function(k,v){
        $('#'+k).toggleClass('seq_mute', v);
      });
    }
    
    // table;
    //[0] loop start (0=none)
    //[1] loop end (0=none)
    function set_seq_loop(arr){
      $('.seq_loop').removeClass('seq_loop');
      if (arr[0] > 0){
        for (i=arr[0];i<=arr[1];i++){
          $('#s'+i).addClass('seq_loop');
        }
      }
    }


    function load_matrix_table(callback){
      //Get Matrix
      $.get('/matrix/matrix_table.lua', function(data){

        //Display Content
        $("#matrix_placeholder").html(data);

        //Floating Table Head
        $("#table_matrix").chromatable({
          height: "600px",
          width: "1000px"
        });

        //Track Colors

        if (typeof callback == "function"){
          callback();
        }
      });
    }
    
    function log(str){
      if (debug==true){
        $('#log').prepend("<p>"+str+"</p>");
      }
    }

    function update(data){
      log(data)
      //eventid:[k=v]
      data = $.parseJSON(data);
      $.each(data, function(k,event){
        switch(event.key) {
          case "sid": set_sid(event.value); break;
          case "mutes_changed": set_mute_state(event.value); break;
          case "song_change": load_matrix_table(); break;
          case "seq_loop": set_seq_loop(event.value); break;
        }
      });

    }
    
    function loop(){
      if (autoupdate){
        $.get('/matrix/get-song-updates.lua', {client_id: client_id}, function(data){ update(data); } );
      }
      setTimeout('loop()', au_interval);
    }


    $(document).ready(function(){
      if (debug==true){
        $("#test-tools").append("<strong>Test Tools</strong>");
        $("#test-tools").append("<button id='update'>update ["+client_id+"]</button>");
        $("#update").click(function(){
          $.get('/matrix/get-song-updates.lua', {client_id: client_id}, function(data){ update(data); } );
        });

        $("#test-tools").append("<button id='autoupdate'>disable auto-update</button>");
        $("#autoupdate").toggle(function(){
          autoupdate = false;
          $("#autoupdate").text("enable auto-update");
          log("disabled auto-update");
        }, function(){
          autoupdate = true;
          $("#autoupdate").text("disable auto-update");
          log("enabled auto-update");
        });
        
        $("#test-tools").show();
        $("#log").show();
      }


      //Polling Renoise for song changes
        load_matrix_table(loop);

    }); // end document ready



    //Track Hover
    var old_tid = 0;
    $("td").live('mouseover', function(){
      if (!$(this).hasClass('p')) return false;
      var id = $(this).attr('id'); //s03t04
      var tid = id.substr(id.indexOf("t")+1);
      if (old_tid != tid) {
        $("#t"+old_tid).removeClass("hover");
        $("#t"+tid).addClass("hover");
      }
      old_tid = tid;
    });

    //Seq Loop
    //jquery ui selectable
    /*
    $(".l").live('click', function(){
      var sid = $(this).parent().attr('id').substr(1);
      var url = "get-song-updates.lua";
      //renoise.song().transport.loop_sequence_range
      var data = {ajax:true, }
      var p = this;
      $.post(url, data, function(){
        $(".s").removeClass('scheduled');
        $(p).addClass('scheduled');
      });
      return false;
    });
    */

    //Set Schedule
    $(".s").live('click', function(){
      var sid = $(this).parent().attr('id').substr(1);
      var url = "/Seq. Triggering/Schedule/Sequence XX [Set]?i="+sid;
      var p = this;
      $.post(url, {ajax:true}, function(){
        $(".s").removeClass('scheduled');
        $(p).addClass('scheduled');
      });
      return false;
    });

    //Seq Trigger
    $(".pid").live('click', function(){
      var sid = $(this).parent().attr('id').substr(1);
      var url = "/Seq. Triggering/Trigger/Sequence XX [Set]?i="+sid;
      var p = this;
      $.post(url, {ajax:true});
      return false;
    });

    //Seq Mute
    $(".p").live('click', function(){
     var p = this

     var id = $(this).attr('id');
     var arr = id.match(/\d+/g);
     var seq = arr[0];
     var tid = arr[1];
     
     ~{do
       local url = Util:urlencode(
         "/Seq. Muting/Seq. XX [Toggle]/Seq. #seq/Mute Track #tid [Toggle]")
       url = url:gsub("%%23seq", "%%23'+seq+'")  
       url = url:gsub("%%23tid", "%%23'+tid+'")
       OUT = ("var url = '%s';"):format(url)
     end }
     
     $.post(url, {ajax:true}, function(){
      $(p).toggleClass('seq_mute');
     });
     return false;
    });
  </script>
</body>
</html>
